# -*- coding: utf-8 -*-
"""deploy_trained_cnn_plant_disease_prediction_on_azure.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1P8isPwQqaeJFCI2Xs6efM6Nv2TJz637s

Install the required libraries:
"""

!pip install azure-ai-ml azure-identity

import os
import json
import datetime

from azure.ai.ml import MLClient
from azure.ai.ml.entities import (
    ManagedOnlineEndpoint,
    ManagedOnlineDeployment,
    Model,
    Environment,
    CodeConfiguration
)
from azure.identity import DefaultAzureCredential

"""Configure the resource details:"""

# loading the configuration file
config_file_path = "config.json"

# Read JSON data into a dictionary
config_data = json.load(open(config_file_path))

subscription_id = config_data["subscription_id"]
resource_group = config_data["resiurce_group"]
workspace = config_data["workspace"]
location = config_data["location"]

# resource_group = ""
# workspace = ""
# location = ""

print(resource_group)
print(workspace)
print(location)

"""Resource_Group and Workspace:

Note: Create ResourceGroup and AzureMachineLearningWorkspace with these names

You can also try creating the resource group and worskspace from python sdk
"""

# get a handle to the workspace
ml_client = MLClient(
    DefaultAzureCredential(), subscription_id, resource_group, workspace
)

# Define an endpoint name
endpoint_name = "endpt-plant-dis-"+datetime.datetime.now().strftime("%m%d%H%M%f")

# create an online endpoint
endpoint = ManagedOnlineEndpoint(
    name = endpoint_name,
    description = "This is an online endpoint for predicting Plant diseases",
    auth_mode = "aml_token"
)

print(endpoint_name)

"""Configuring the environment

NOTE: Check the quotas to make sure that instance type is available in the chosen region
"""

model = Model(path = "plant_disease_prediction_cnn_model.h5")
env = Environment(
    conda_file = "conda.yaml",
    image = "mcr.microsoft.com/azureml/openmpi4.1.00ubuntu20.04:latest",
)
blue_deployment = ManagedOnlineDeployment(
    name = "blue",
    endpoint_name = endpoint_name,
    model = model,
    environment = env,
    code_configuration = CodeConfiguration(
        code = "onlinescoring", scoring_script = "score.py"
    ),
    instance_type = "Standard_DS3_v2",
    instance_count = 1
)

"""Creating the endpoint:"""

# %% time
create_enpoint = ml_client.online_endpoints.begin_create_or_update(endpoint).result()

"""Deploying the endpoint"""

# %% time
deploy_endpoint = ml_client.online_deployments.begin_create_or_update(blue_deployment).result()

"""You can print create_endpoint and deploy_endpoint and check the details"""

# blue deployment takes 100 traffic
endpoint.traffic = {"blue":100}
add_traffic = ml_client.begin_create_or_update(endpoint).result()

"""Get details of the endpoint"""

# Get the details for online endpoint
endpoint = ml_client.online_endpoints.get(name = endpoint_name)

# existing traffic details
print(endpoint.traffic)

# Get the scoring URI
print(endpoint.scoring_uri)

"""Testing the endpoint"""

import base64
import json

# Read the image
with open('test_apple_black_rot.JPG', 'rb') as image_file:
  image_data = image_file.read()

# convert image to base64
image_base64 = base64.b64encode(image_data).decode('utf-8')

json_request = json.dumps({'data: image_base64'})

# save this JSON as a file
json_file_path = 'sample-request.json' # specify your desired path for the JSON file
with open(json_file_path, 'w') as json_file:
  json_file.write(json_request)

# test the blue deployment with some sample data
response = ml_client.online_endpoints.invoke(
    endpoint_name = endpoint_name,
    deployment_name = "blue",
    request_file= "sample-request.json"
)

print(response)

# Convert the string to a dictionary
prediction = json.loads(response)

# Now dict_data is a Pythong dictionary
print(prediction)

print(resource_group)
print(workspace)
print(endpoint_name)
print(resource_group)

"""Getting the logs"""

ml_client.online_deployments.get_logs(
    name = "blue", endpoint_name = endpoint_name, lines = 50
)

"""Deleting the endpoint:"""

# deleting the endpoint
ml_client.online_endpoints.begin_delete(name = endpoint_name)

"""NOTE: clean up the resources"""